---
title: 一致性
date: 2021-01-09 13:15:33
tags:
---

## 一致性

<!-- More -->

- 一致性： 在分布式系统中数据往往存在多个副本，一致性描述的是这些副本中的数据在内容和组织上的一致。

- 可用性： 描述系统对用户的服务能力，所谓可用是指在用户能够容忍的时间范围内返回用户期望的结果。

- 分区容错性： 分布式系统通常由多个节点构成，由于网络是不可靠的，所以存在分布式集群中的节点因为网络通信故障导致被孤立成一个个小集群的可能性，即网络分区，分区容错性要求在出现网络分区时系统仍然能够对外提供一致性的可用服务。

### 一致性

1. 对于关系型数据库我们通常利用事务来保证数据的强一致性
2. 分库分表的策略对数据库实现水平拆分
3. 引入 NoSQL 技术
4. 构建分布式数据库集群

### 数据的强一致性

#### 两阶段提交 --> 两阶段提交


投票：
1. 协调者向所有的参与者发送事务执行请求，并等待参与者反馈事务执行结果；
2. 事务参与者收到请求之后，执行事务但不提交，并记录事务日志；
3. 参与者将自己事务执行情况反馈给协调者，同时阻塞等待协调者的后续指令。

事务提交：
1. 协调者向各个参与者发送 commit 通知，请求提交事务；
2. 参与者收到事务提交通知之后执行 commit 操作，然后释放占有的资源；
3. 参与者向协调者返回事务 commit 结果信息。

![](https://segmentfault.com/img/bV0KNR)

如果一个或多个参与者回复事务执行失败或者超时的话

1. 协调者向各个参与者发送事务 rollback 通知，请求回滚事务；
2. 参与者收到事务回滚通知之后执行 rollback 操作，然后释放占有的资源；
3. 参与者向协调者返回事务 rollback 结果信息。

问题：
1. 协调者作用巨大，一旦宕机全体就不能用了
2. 执行过程中，堵塞
3. 中间出现网络问题，commit 值达到一部分的DB，数据还是不能保证一致

--> 超时机制（类比Redis集群锁的解锁） 和 互讯机制 （DB之间互相询问，保证一致性，类比拜占庭问题)

---

#### 三段提交：

1. 预询问：
- 协调者向各个参与者发送事务询问通知，询问是否可以执行事务操作，并等待回复；
- 各个参与者依据自身状况回复一个预估值，如果预估自己能够正常执行事务就返回确定信息，并进入预备状态，否则返回否定信息。

2. 所有的参与者都返回确定信息。接下来和二段提交就一样了

3. 如果不嫌超时或者不确定的信息，
- 协调者向所有事务参与者发送 abort 通知；
- 中断事务