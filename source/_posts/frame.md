---
title: frame
date: 2020-12-15 01:05:43
tags:
---


## 栈帧

函数每次被调用时，要在调用栈(call stack)上占用一段空间，
在这段空间上保存调用者栈帧的基址(ebp)、本函数的局部变量、调用其他函数时的返回地址，
并在需要时保存调用者使用的寄存器值，
被调函数结束后esp上移表示释放这段空间，然后回到调用者的占用的空间与代码位置继续执行，
函数运行阶段在调用栈上占用的这段空间就叫做栈帧，是编译原理运行时空间组织中活动记录（activation record）的一种实现

栈帧主要通过 ebp、esp 两个寄存器维护，ebp 始终指向栈底，esp 始终指向栈顶

每个函数被调用时执行下面两条命令
```
pushl	%ebp			; ebp入栈，保存调用者的栈帧基址，以便返回
movl	%esp, %ebp		; 将当前 esp 的位置作为当前栈帧的基址
```

这样在当前栈帧向上一栈帧退回时，只需要取出之前压栈的基址
另一方面，调用过程的指令 call

>call a_func

这样被调函数返回调用函数前就可以将 ebp、esp 置回调用函数的栈帧位置
并返回 call 指令的下一条指令执行

### 栈边界的字节对齐
 

在现代处理器中，GCC会将堆栈默认对齐为16字节对齐

因为 SSE2 指令集(Streaming SIMD Extensions，单指令多数据扩展指令集)具有16字节大小的和 XMM 寄存器，

因此，在进行函数调用时，它会自动对齐到16个字节，而在函数外部保持为 8 字节对齐

常常可以见到 andl $-16, %esp 或者 andl 0xFFFFFFF0, %esp，即是 esp 向下移动到 16 字节对齐处